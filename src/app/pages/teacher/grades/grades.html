<div class="space-y-6">
	<!-- Header -->
	<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-6">
		<div class="flex items-center justify-between">
			<div>
				<h2 class="text-2xl font-bold text-gray-900 mb-2">Calificaciones</h2>
				<p class="text-gray-600">Gestiona las calificaciones de tus estudiantes</p>
			</div>
			@if (selectedClass()) {
				<app-button [variant]="'primary'" [size]="'md'" (click)="openAddGradeModal()">
					<span class="material-symbols-outlined text-lg mr-2">add</span>
					Agregar Calificación
				</app-button>
			}
		</div>
	</div>

	<!-- Class Selector -->
	@if (!loading() && classes().length > 0) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-6">
			<div class="block text-sm font-medium text-gray-700 mb-3">Seleccionar Clase</div>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
				@for (cls of classes(); track cls.id) {
					<button
						type="button"
						(click)="selectClass(cls)"
						[class]="'p-4 rounded-lg border-2 text-left transition-all ' + (selectedClass()?.id === cls.id ? 'border-emerald-600 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300')"
					>
						<div class="font-semibold text-gray-900">{{ cls.className }}</div>
						<div class="text-sm text-gray-600">Sección {{ cls.section }}</div>
					</button>
				}
			</div>
		</div>
	}

	<!-- Loading State -->
	@if (loading()) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-12 text-center">
			<div
				class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-emerald-600 border-r-transparent mb-4"
			></div>
			<p class="text-gray-600">Cargando...</p>
		</div>
	}

	<!-- Statistics -->
	@if (!loading() && selectedClass() && students().length > 0) {
		<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
			<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-6">
				<div class="flex items-center justify-between">
					<div>
						<p class="text-sm text-gray-600">Promedio de Clase</p>
						<p class="text-3xl font-bold text-emerald-600">{{ classAverage().toFixed(1) }}%</p>
					</div>
					<span class="material-symbols-outlined text-4xl text-emerald-600">analytics</span>
				</div>
			</div>
			<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-6">
				<div class="flex items-center justify-between">
					<div>
						<p class="text-sm text-gray-600">Total Estudiantes</p>
						<p class="text-3xl font-bold text-emerald-600">{{ students().length }}</p>
					</div>
					<span class="material-symbols-outlined text-4xl text-emerald-600">groups</span>
				</div>
			</div>
			<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-6">
				<div class="flex items-center justify-between">
					<div>
					<p class="text-sm text-gray-600">Calificaciones Publicadas</p>
					<p class="text-3xl font-bold text-emerald-600">
						{{ totalGrades() }}
					</p>
					</div>
					<span class="material-symbols-outlined text-4xl text-emerald-600">grade</span>
				</div>
			</div>
		</div>
	}

	<!-- Search -->
	@if (!loading() && selectedClass() && students().length > 0) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-6">
			<app-input
				[label]="'Buscar Estudiante'"
				[type]="'text'"
				[value]="searchQuery()"
				(valueChange)="searchQuery.set($event)"
				[placeholder]="'Nombre o email del estudiante'"
			/>
		</div>
	}

	<!-- Students Table -->
	@if (!loading() && selectedClass() && filteredStudents().length > 0) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 overflow-hidden">
			<div class="overflow-x-auto">
				<table class="w-full">
					<thead class="bg-emerald-50 border-b border-emerald-200">
						<tr>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
								Estudiante
							</th>
							<th class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
								Calificaciones
							</th>
							<th class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
								Promedio
							</th>
							<th class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
								Letra
							</th>
							<th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
								Acciones
							</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						@for (student of filteredStudents(); track student.id) {
							<tr class="hover:bg-gray-50 transition-colors">
								<td class="px-6 py-4">
									<div class="flex items-center">
										<div class="h-10 w-10 rounded-full bg-emerald-100 flex items-center justify-center mr-3">
											<span class="material-symbols-outlined text-emerald-600">person</span>
										</div>
										<div>
											<div class="font-medium text-gray-900">{{ student.fullName }}</div>
											<div class="text-sm text-gray-500">{{ student.email }}</div>
										</div>
									</div>
								</td>
								<td class="px-6 py-4 text-center">
									<div class="flex flex-wrap gap-2 justify-center">
										@for (grade of student.grades; track grade.id) {
											<button
												type="button"
												(click)="openEditGradeModal(grade)"
												class="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors"
												title="{{ grade.gradeName }}: {{ grade.earnedPoints }}/{{ grade.maxPoints }}"
											>
												{{ getGradeTypeLabel(grade.gradeType) }}: {{ grade.gradeValue.toFixed(0) }}%
											</button>
										}
										@if (student.grades.length === 0) {
											<span class="text-sm text-gray-400">Sin calificaciones</span>
										}
									</div>
								</td>
								<td class="px-6 py-4 text-center">
									<span class="text-lg font-semibold text-gray-900">
										{{ student.average > 0 ? student.average.toFixed(1) + '%' : '-' }}
									</span>
								</td>
								<td class="px-6 py-4 text-center">
									@if (student.average > 0) {
										<span
											[class]="'text-2xl font-bold ' + getGradeLetterColor(student.gradeLetter)"
										>
											{{ student.gradeLetter }}
										</span>
									} @else {
										<span class="text-gray-400">-</span>
									}
								</td>
								<td class="px-6 py-4 text-right">
									<app-button
										[variant]="'primary'"
										[size]="'sm'"
										(click)="openAddGradeModal(student.id)"
									>
										<span class="material-symbols-outlined text-sm">add</span>
									</app-button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		</div>
	}

	<!-- Empty States -->
	@if (!loading() && classes().length === 0) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-12 text-center">
			<div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg inline-block mb-4">
				<span class="material-symbols-outlined text-white text-5xl">school</span>
			</div>
			<p class="text-xl text-gray-600 font-medium">No tienes clases asignadas</p>
			<p class="text-sm text-gray-500 mt-2">Contacta al administrador.</p>
		</div>
	}

	@if (!loading() && selectedClass() && students().length === 0) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-12 text-center">
			<div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg inline-block mb-4">
				<span class="material-symbols-outlined text-white text-5xl">groups</span>
			</div>
			<p class="text-xl text-gray-600 font-medium">No hay estudiantes inscritos</p>
			<p class="text-sm text-gray-500 mt-2">Esta clase no tiene estudiantes inscritos.</p>
		</div>
	}

	@if (!loading() && selectedClass() && students().length > 0 && filteredStudents().length === 0) {
		<div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-100 p-12 text-center">
			<p class="text-xl text-gray-600 font-medium">No se encontraron estudiantes</p>
			<p class="text-sm text-gray-500 mt-2">Intenta con otro término de búsqueda.</p>
		</div>
	}
</div>

<!-- Add/Edit Grade Modal -->
@if (showAddGradeModal()) {
	<div
		class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"
		role="dialog"
		aria-modal="true"
		(click)="closeModal()"
		(keydown.escape)="closeModal()"
	>
		<div
			class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] overflow-y-auto"
			role="document"
			(click)="$event.stopPropagation()"
			(keydown)="$event.stopPropagation()"
		>
			<!-- Modal Header -->
			<div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6">
				<h2 class="text-2xl font-bold text-white">
					{{ editingGrade() ? 'Editar Calificación' : 'Agregar Calificación' }}
				</h2>
			</div>

			<!-- Modal Body -->
			<form (submit)="$event.preventDefault(); saveGrade()" class="p-6 space-y-6">
				<!-- Student Selector -->
				@if (!editingGrade()) {
					<div>
						<label for="student-select" class="block text-sm font-medium text-gray-700 mb-2">
							Estudiante *
						</label>
						<select
							id="student-select"
							[value]="selectedStudentId() || ''"
							(change)="selectedStudentId.set($any($event.target).value)"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
							required
						>
							<option value="" disabled>Selecciona un estudiante</option>
							@for (student of students(); track student.id) {
								<option [value]="student.id">{{ student.fullName }}</option>
							}
						</select>
					</div>
				}

				<!-- Grade Name -->
				<app-input
					[label]="'Nombre de la Calificación *'"
					[type]="'text'"
					[value]="gradeName()"
					(valueChange)="gradeName.set($event)"
					[placeholder]="'Ej: Examen Parcial 1'"
					[required]="true"
				/>

				<!-- Grade Type -->
				<div>
					<label for="grade-type" class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
					<select
						id="grade-type"
						[value]="gradeType()"
						(change)="gradeType.set($any($event.target).value)"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
					>
						@for (type of gradeTypes; track type.value) {
							<option [value]="type.value">{{ type.label }}</option>
						}
					</select>
				</div>

				<!-- Points -->
				<div class="grid grid-cols-2 gap-4">
					<div>
						<label for="earned-points" class="block text-sm font-medium text-gray-700 mb-2">
							Puntos Obtenidos *
						</label>
						<input
							id="earned-points"
							type="number"
							[value]="earnedPoints()"
							(input)="earnedPoints.set(+$any($event.target).value)"
							min="0"
							[max]="maxPoints()"
							step="0.5"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
							required
						/>
					</div>
					<div>
						<label for="max-points" class="block text-sm font-medium text-gray-700 mb-2">
							Puntos Máximos *
						</label>
						<input
							id="max-points"
							type="number"
							[value]="maxPoints()"
							(input)="maxPoints.set(+$any($event.target).value)"
							min="1"
							step="0.5"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
							required
						/>
					</div>
				</div>

				<!-- Calculated Percentage -->
				<div class="bg-emerald-50 p-4 rounded-lg">
					<p class="text-sm text-gray-700">
						<strong>Porcentaje:</strong>
						<span class="text-emerald-600 font-bold text-lg ml-2">
							{{ maxPoints() > 0 ? ((earnedPoints() / maxPoints()) * 100).toFixed(1) : 0 }}%
						</span>
					</p>
				</div>

				<!-- Weight (Optional) -->
				<div>
					<label for="weight" class="block text-sm font-medium text-gray-700 mb-2">
						Peso (% del total, opcional)
					</label>
					<input
						id="weight"
						type="number"
						[value]="weight()"
						(input)="weight.set(+$any($event.target).value)"
						min="0"
						max="100"
						step="1"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
						placeholder="0 = sin peso"
					/>
					<p class="text-xs text-gray-500 mt-1">Deja en 0 para promedio simple</p>
				</div>

				<!-- Comments -->
				<div>
					<label for="comments" class="block text-sm font-medium text-gray-700 mb-2">Comentarios</label>
					<textarea
						id="comments"
						[value]="comments()"
						(input)="comments.set($any($event.target).value)"
						rows="3"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
						placeholder="Comentarios adicionales (opcional)"
					></textarea>
				</div>

				<!-- Error Message -->
				@if (formError()) {
					<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
						{{ formError() }}
					</div>
				}
			</form>

			<!-- Modal Footer -->
			<div class="p-6 bg-gray-50 flex items-center justify-between">
				<div>
					@if (editingGrade()) {
						<app-button
							[variant]="'ghost'"
							[size]="'md'"
							(click)="deleteGrade(editingGrade()!)"
							class="text-red-600 hover:text-red-700"
						>
							<span class="material-symbols-outlined text-sm mr-1">delete</span>
							Eliminar
						</app-button>
					}
				</div>
				<div class="flex items-center gap-3">
					<app-button [variant]="'ghost'" [size]="'md'" (click)="closeModal()">
						Cancelar
					</app-button>
					<app-button
						[variant]="'primary'"
						[size]="'md'"
						(click)="saveGrade()"
						[disabled]="!canSubmit() || saving()"
					>
						{{ saving() ? 'Guardando...' : 'Guardar' }}
					</app-button>
				</div>
			</div>
		</div>
	</div>
}
